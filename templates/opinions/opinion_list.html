{% extends "base.html" %}

<!-- opinion_list.html start -->
{% load i18n %}
{% load static %}
{% load humanize %}
{% load tz %}
{% load form_field %}
{% load dict_value %}

{% block extra_js_head %}
<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script type="text/javascript" src="{% static 'jquery/jquery-3.6.1.min.js' %}"><\/script>')</script>
{% endblock extra_js_head %}

{% block head_title %}SoapBox - {{ title }}{% endblock %}

{% block extra_css %}
<link href="{% static 'css/styles-opinion.css' %}" rel="stylesheet">
{% endblock extra_css %}

{% block content %}
{% if page_heading %}
<div class="row mt-2">
    <div class="col-12 text-center">
        <h3>{{ page_heading }}</h3>
    </div>
</div>
{% endif %}

{% if paginator.count > 0 %}
    <div class="row">
        <div class="col-lg-2 offset-lg-10 col-md-4 offset-md-8 col-sm-6 offset-sm-6 col-auto mt-2">
            <!-- sort order selection -->
            <select id="sort-order-select" class="form-select" aria-label="Sort by">
                {% for sort_opt in sort_order %}
                    <option value="{{ sort_opt.arg }}"
                        {% if sort_opt == selected_sort %}
                        selected
                        {% endif %}
                    >
                        {{ sort_opt.display }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
{% endif %}

<article id="article-content" class="row d-flex justify-content-center">
    {% include "opinions/opinion_list_content.html" %}
</article>

{% endblock content %}

{% block extra_js_body %}
    <script>
        /**
         * Update sort order/per page
         * :param event: change event
         */
        function update_content(order, per_page, page) {

            if (page === undefined) {
                page = "?page=1"
            }

            // remove per page and page handlers as new elements will be returned with the response
            $('#per-page-select').off();
            $('.page-item').off();

            const repeat_search = $('#var__repeat_search_term').text().trim();
            const query_args = [
                "order=" + order, "per-page=" + per_page, "reorder=1"
            ];
            if (repeat_search.length > 0) {
                query_args.push(repeat_search)
            }

            $.ajax({
                url: page + "&" + query_args.join("&")
            }).done(function(data) {
                $('#article-content').html(data);

                $('#per-page-select').ready(function(event) {
                    add_page_content_handlers();
                });
            });
        }

        /** Get current per page value */
        function get_per_page() {
            return $('#per-page-select').find(":selected").val();
        }

        /** Get current order value */
        function get_order() {
            return $('#sort-order-select').find(":selected").val()
        }

        /** Get current page value */
        function get_page() {
            const page = $('#current-page').find("a");
            return page.length ? "?page=" + page.text().trim() : undefined
        }

        /**
         * Add change handler for per page selector and pages
         */
        function add_page_content_handlers() {
            /**
             * Change handler for per page
             * :param event: change event
             */
             $('#per-page-select').on( "change", function(event) {
                update_content(get_order(), event.target.value, get_page())
            });
            /**
             * Click handler for page request
             * :param event: change event
             */
             $('.page-item').on( "click", function(event) {
                event.preventDefault();
                update_content(get_order(), get_per_page(), event.currentTarget.firstElementChild.href)
            });
        }


        $(document).ready(function() {
            /**
             * Change handler for sort order
             * :param event: change event
             */
            $('#sort-order-select').on( "change", function(event) {
                update_content(event.target.value, get_per_page(), get_page())
            });

            add_page_content_handlers();
        });
    </script>
{% endblock extra_js_body %}
<!-- opinion_list.html end -->
