<!--
  ~ MIT License
  ~
  ~ Copyright (c) 2022 Ian Buttimer
  ~
  ~ Permission is hereby granted, free of charge, to any person obtaining a copy
  ~ of this software and associated documentation files (the "Software"), to
  ~ deal in the Software without restriction, including without limitation the
  ~ rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  ~ sell copies of the Software, and to permit persons to whom the Software is
  ~ furnished to do so, subject to the following conditions:
  ~
  ~ The above copyright notice and this permission notice shall be included in
  ~ all copies or substantial portions of the Software.
  ~
  ~ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  ~ IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  ~ FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  ~ AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  ~ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  ~ FROM,OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
  ~ DEALINGS IN THE SOFTWARE.
  ~
  -->

{% extends "base.html" %}

{% load i18n %}
{% load static %}
{% load humanize %}
{% load tz %}
{% load form_field %}
{% load dict_value %}

{% block extra_js_head %}
<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script type="text/javascript" src="{% static 'jquery/jquery-3.6.1.min.js' %}"><\/script>')</script>
{% endblock extra_js_head %}

{% block head_title %}SoapBox - {{ title }}{% endblock %}

{% block content %}
{% if search_term %}
<div class="row mt-2">
    <div class="col-12 text-center">
        <h3>Results of {{ search_term }}</h3>
    </div>
</div>
{% endif %}

{% if paginator.count > 0 %}
    <div class="row">
        <div class="col-2 offset-10 mt-2">
            <!-- sort order selection -->
            <select id="sort-order-select" class="form-select" aria-label="Sort by">
                {% for sort_opt in sort_order %}
                    <option value="{{ sort_opt.arg }}"
                        {% if sort_opt.value == selected_sort %}
                        selected
                        {% endif %}
                    >
                        {{ sort_opt.display }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
{% endif %}

<article id="article-content" class="row">
    {% include "opinions/opinion_list_content.html" %}
</article>

{% endblock content %}

{% block extra_js_body %}
    <script>
        /**
         * Update sort order/per page
         * :param event: change event
         */
        function update_content(order, per_page, page) {

            if (page == undefined) {
                page = "?page=1"
            }

            // remove per page and page handlers as new elements will be returned with the response
            $('#per-page-select').off();
            $('.page-item').off();

            repeat_search = $('#var__repeat_search_term').text().trim()

            $.ajax({
                url: page + "&" + [
                        "order=" + order,
                        "per-page=" + per_page,
                        "reorder=1",
                        repeat_search,
                    ].join("&")
            }).done(function(data) {
                $('#article-content').html(data);

                $('#per-page-select').ready(function(event) {
                    add_page_content_handlers();
                });
            });
        };

        /** Get current per page value */
        function get_per_page() {
            return $('#per-page-select').find(":selected").val();
        };

        /** Get current order value */
        function get_order() {
            return $('#sort-order-select').find(":selected").val()
        };

        /** Get current page value */
        function get_page() {
            page = $('#current-page').find("a")
            return page.length ? "?page=" + page.text().trim() : undefined
        };

        /**
         * Add change handler for per page selector and pages
         */
        function add_page_content_handlers() {
            /**
             * Change handler for per page
             * :param event: change event
             */
             $('#per-page-select').on( "change", function(event) {
                update_content(get_order(), event.target.value, get_page())
            });
            /**
             * Click handler for page request
             * :param event: change event
             */
             $('.page-item').on( "click", function(event) {
                event.preventDefault();
                update_content(get_order(), get_per_page(), event.currentTarget.firstElementChild.href)
            });
        }


        $(document).ready(function() {
            /**
             * Change handler for sort order
             * :param event: change event
             */
            $('#sort-order-select').on( "change", function(event) {
                update_content(event.target.value, get_per_page(), get_page())
            });

            add_page_content_handlers();
        });
    </script>
{% endblock extra_js_body %}
