<!--
  ~ MIT License
  ~
  ~ Copyright (c) 2022 Ian Buttimer
  ~
  ~ Permission is hereby granted, free of charge, to any person obtaining a copy
  ~ of this software and associated documentation files (the "Software"), to deal
  ~ in the Software without restriction, including without limitation the rights
  ~ to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  ~ copies of the Software, and to permit persons to whom the Software is
  ~ furnished to do so, subject to the following conditions:
  ~
  ~ The above copyright notice and this permission notice shall be included in
  ~ all copies or substantial portions of the Software.
  ~
  ~ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  ~ IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  ~ FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  ~ AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  ~ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  ~ OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  ~ SOFTWARE.
  -->

<!-- reactions_js.html start -->
<script>
    /**
     * Update react status of current opinion
     * :param event: click event
     * :param done_func: reaction specific done handler function
     */
    function updateReactStatus(event, done_func) {
        // hide tooltip
        $("#" + event.currentTarget.id).tooltip("hide");

        const reaction = get_react_info(event)

        $.ajax({
            url: reaction.url + "?status=" + reaction.option,
            method: 'patch',
            headers: {
                'X-CSRFTOKEN': '{{ csrf_token }}'
            }
        }).done(function(data) {
            done_func(data);

            // set click handlers for reactions
            setReactionHandlers();
            enableTooltips();
        });
    }

    const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();

    /**
     * Get react info
     * :param event: click event
     */
    function get_react_info(event) {
        // ids are of the form 'id--react-<reaction>-<type>-<id>' e.g. 'id--react-agree-opinion-1'
        const split = event.currentTarget.attributes['id'].textContent.split('-')
        let data_bs_option = '';
        if (event.currentTarget.firstElementChild.attributes.hasOwnProperty('data-bs-option')) {
            data_bs_option = event.currentTarget.firstElementChild.attributes['data-bs-option'].textContent
        }
        return {
            // href is on the button
            url: event.currentTarget.attributes['data-bs-href'].textContent,
            // title is on the button
            title: event.currentTarget.attributes['data-bs-title'].textContent,
            // type is taken from the button id
            type: split[4],
            // status option is on the span in the button (see reactions.html)
            option: data_bs_option,
            // status option is the action to perform
            action: data_bs_option,
            submit: capitalize(data_bs_option)
        };
    }
    /**
     * Set react info vars
     * :param event: click event
     * :param ids: object with keys matching those returned by get_react_info()
     *             and values as ids of element to be set
     */
    function set_react_info_vars(event, ids) {
        const reaction = get_react_info(event)
        for (const [key, value] of Object.entries(ids)) {
            $(value).text(reaction[key]);
        }
    }

    /**
     * Handle the response to a reaction
     * :param data: json data
     */
    function react_response_handler(data) {
        if (data.hasOwnProperty('redirect')) {
            document.location.href = data.redirect;
        } else if (data.hasOwnProperty('element_id')) {
            $("#" + data.element_id).replaceWith(data.html);
        }
    }

    /**
     * Update like/unlike status of current opinion
     * :param event: click event
     */
    function updateLikeUnlike(event) {
        updateReactStatus(event, react_response_handler);
    }

    /**
     * Update pin/unpin status of current opinion
     * :param event: click event
     */
    function updatePinUnpin(event) {
        updateReactStatus(event, react_response_handler);
    }

    // Reaction buttons for comments are named 'id--react-comment-....'
    const commentReactionsSelector = "button[id^='id--react-comment']";
    // Reaction buttons for like are named 'id--react-agree-....'
    const likeReactionsSelector = "button[id^='id--react-agree']";
    // Reaction buttons for unlike are named 'id--react-disagree-....'
    const unlikeReactionsSelector = "button[id^='id--react-disagree']";
    // Reaction buttons for hide are named 'id--react-hide-....'
    const hideReactionsSelector = "button[id^='id--react-hide']";
    // Reaction buttons for hide are named 'id--react-show-....'
    const showReactionsSelector = "button[id^='id--react-show']";
    // Reaction buttons for pin are named 'id--react-pin-....'
    const pinReactionsSelector = "button[id^='id--react-pin']";
    // Reaction buttons for unpin are named 'id--react-unpin-....'
    const unpinReactionsSelector = "button[id^='id--react-unpin']";
    // Reaction buttons for report are named 'id--react-report-....'
    const reportReactionsSelector = "button[id^='id--react-report']";

    /* Set the click handlers to set the submit url for comments */
    function setReactionHandlers() {
        /* TODO removing and adding all the handlers is unnecessary */

        // remove old handlers to prevent duplicates
        for (let selector of [
                commentReactionsSelector, likeReactionsSelector, unlikeReactionsSelector,
                hideReactionsSelector, showReactionsSelector,
                pinReactionsSelector, unpinReactionsSelector,
                reportReactionsSelector
        ]) {
            $(selector).off();
        }

        // add new handlers
        $(commentReactionsSelector).on('click', (event) => {
            // set the submit url for comments
            set_react_info_vars(event, {
                url: "#id--comment-submit-url"
            });
        });
        $(reportReactionsSelector).on('click', (event) => {
            // set the submit url for reports
            set_react_info_vars(event, {
                url: "#id--report-submit-url"
            });
        });
        for (let selector of [likeReactionsSelector, unlikeReactionsSelector]) {
            $(selector).on('click', (event) => {
                // update like/unlike status
                updateLikeUnlike(event);
            });
        }
        for (let selector of [hideReactionsSelector, showReactionsSelector]) {
            $(selector).on('click', (event) => {
                // set the submit url/option/title for hide/show
                set_react_info_vars(event, {
                    // keys are value names, values are ids of tags to update
                    url: "#id--hide-submit-url",
                    option: "#id--hide-submit-option",
                    title: "#id--hide-modal-heading",
                    type: "#id--hide-modal-element",
                    action: "#id--hide-modal-action",
                    submit: "#id--submit-btn-hide-modal",
                });
            });
        }
        for (let selector of [pinReactionsSelector, unpinReactionsSelector]) {
            $(selector).on('click', (event) => {
                // update pin/unpin status
                updatePinUnpin(event);
            });
        }
    }

    $(document).ready(function () {
        // set click handlers for reactions
        setReactionHandlers();
    });
</script>
<!-- reactions_js.html end -->
