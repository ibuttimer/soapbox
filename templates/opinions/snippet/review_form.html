{# --- template variable defines for includes --- #}
{# review request header template expects: 'is_assigned' as current user is assigned reviewer flag #}
{#                                         'review_form' as list of Review #}
{#                                         'opinion' as Opinion #}
{#                                         'is_review' as in review mode boolean #}
{#                                         'review_button' as dict with status display as key and class as value #}

{% load i18n %}
{% load form_field %}
{% load array_value %}
{% load dict_value %}
{% load calc %}

<div id="id--review-form-container">
    {% if review_form and is_assigned %}
    <form method="post" action="{% url 'opinions:review_decision_opinion_id' opinion.id %}"
          id="id--review-form">
        {% csrf_token %}

        <div id="id--review-form-errors-container">
            {% with form=review_form %}
            {% include "snippet/form_errors.html" %}
            {% endwith %}
        </div>

        <fieldset>
            <div class="row mb-3">
                <legend>{{ review_form.review_result.label }}</legend>
                {% calc 12 '/' review_form.review_result.field.choices as width %}
                {% for radio in review_form.review_result %}
                    {% array_value review_form.review_result.field.choices forloop.counter0 as radio_choice %}
                    {% array_value radio_choice 0 as radio_val %}
                    {% dict_value review_button radio.choice_label as label_class %}

                    <div class="col-sm-{{ width }}">
                        <input type="radio" class="btn-check" name="review_result" id="{{ radio.id_for_label }}" value="{{ radio_val }}">
                        <label class="{{ label_class }}" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                    </div>
                {% endfor %}
            </div>
            <div class="row mb-3">
                {% form_field review_form 'reason' as reason_field %}
                <div class="col-sm-2 text-start">
                    <label for="{{ reason_field.auto_id }}" class="form-label">{{ reason_field.label }}</label>
                </div>
                <div class="col-sm-10">
                    {{ reason_field }}
                </div>
            </div>
        </fieldset>
        <div class="modal-footer">
            <button type="submit" class="btn btn-success">{% trans "Submit" %}</button>
        </div>
    </form>


    <script>
        {% if is_review %}
        /**
         * Update review status of current opinion
         * :param new_status: new status, one of 'withdrawn, 'pending-review',
         *                    'under-review', 'approved' or 'rejected'
         */
        function updateReviewStatus(new_status) {
            $.ajax({
                url: "{% url 'opinions:review_status_opinion_id' opinion.id %}?status=" + new_status,
                method: 'patch',
                headers: {
                    'X-CSRFTOKEN': '{{ csrf_token }}'
                }
            }).done(function(data) {
                redirect_rewrite_response_handler(data);
            });
        }

        const reviewFormErrorsSelector = "#id--review-form-errors-container";
        const reviewFormSelector = "form[id^='id--review-form']";

        /* Submit handler for comment modal */
        $(reviewFormSelector).submit(function (event) {

            event.preventDefault();

            const formData = new FormData(event.target);
            const data = {};
            for (const pair of formData.entries()) {
                data[pair[0]] = pair[1]
            }
            const baseUrl = window.location.href.slice(0, window.location.href.indexOf(window.location.pathname))
            const url = `${baseUrl}${$(reviewFormSelector).attr('action')}`;

            console.log('sending');

            $.ajax({
                method: 'post',
                url: url,
                headers: {
                    'X-CSRFTOKEN': '{{ csrf_token }}'
                },
                data: data,
            }).done(function(data) {
                console.log('success');
                redirect_rewrite_response_handler(data);
            }).fail(function(data) {
                // display form errors
                console.log('fail');
                $(reviewFormErrorsSelector).html(data.responseJSON.html);
            });

        });

        {% endif %}
    </script>
    {% endif  %}
</div>
